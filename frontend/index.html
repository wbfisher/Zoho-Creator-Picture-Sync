<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho Pictures Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Zoho Pictures Sync</h1>
            <p class="text-gray-600">Sync images from Zoho Creator to Supabase Storage</p>
        </header>

        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Sync Status</h2>
                <div id="sync-status" class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                    <span class="text-gray-600">Loading...</span>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 rounded p-4 text-center">
                    <div id="total-images" class="text-3xl font-bold text-blue-600">-</div>
                    <div class="text-sm text-gray-600">Total Images</div>
                </div>
                <div class="bg-gray-50 rounded p-4 text-center">
                    <div id="processed-images" class="text-3xl font-bold text-green-600">-</div>
                    <div class="text-sm text-gray-600">Optimized</div>
                </div>
                <div class="bg-gray-50 rounded p-4 text-center">
                    <div id="last-sync" class="text-xl font-semibold text-gray-700">-</div>
                    <div class="text-sm text-gray-600">Last Sync</div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="btn-sync" onclick="triggerSync(false)" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition">
                    Run Incremental Sync
                </button>
                <button id="btn-full-sync" onclick="triggerSync(true)"
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-medium transition">
                    Run Full Sync
                </button>
            </div>
        </div>

        <!-- Recent Runs -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Recent Sync Runs</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left p-3">Started</th>
                            <th class="text-left p-3">Status</th>
                            <th class="text-right p-3">Records</th>
                            <th class="text-right p-3">Synced</th>
                            <th class="text-right p-3">Skipped</th>
                            <th class="text-right p-3">Errors</th>
                        </tr>
                    </thead>
                    <tbody id="runs-table">
                        <tr><td colspan="6" class="p-3 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Images Browser -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Images</h2>
                <div class="flex gap-2">
                    <input type="text" id="filter-tags" placeholder="Filter by tags..." 
                        class="border rounded px-3 py-1.5 text-sm">
                    <select id="filter-category" class="border rounded px-3 py-1.5 text-sm">
                        <option value="">All Categories</option>
                    </select>
                    <button onclick="loadImages()" class="bg-gray-200 hover:bg-gray-300 px-3 py-1.5 rounded text-sm">
                        Filter
                    </button>
                </div>
            </div>
            
            <div id="images-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <div class="col-span-full text-center text-gray-500 py-8">Loading images...</div>
            </div>
            
            <div class="mt-4 flex justify-center gap-2">
                <button id="btn-prev" onclick="loadImages(currentOffset - 50)" 
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded disabled:opacity-50" disabled>
                    Previous
                </button>
                <span id="pagination-info" class="px-4 py-2 text-gray-600">-</span>
                <button id="btn-next" onclick="loadImages(currentOffset + 50)"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" onclick="closeModal()">
        <div class="max-w-4xl max-h-[90vh] p-4" onclick="event.stopPropagation()">
            <img id="modal-image" src="" class="max-w-full max-h-[80vh] object-contain rounded">
            <div id="modal-info" class="bg-white rounded mt-2 p-3 text-sm"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentOffset = 0;

        async function fetchStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                
                // Update status indicator
                const statusEl = document.getElementById('sync-status');
                if (data.is_running) {
                    statusEl.innerHTML = `
                        <span class="w-3 h-3 rounded-full bg-yellow-400 spinner"></span>
                        <span class="text-yellow-600">Syncing...</span>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        <span class="text-green-600">Idle</span>
                    `;
                }
                
                // Update stats
                document.getElementById('total-images').textContent = data.stats.total_images || 0;
                document.getElementById('processed-images').textContent = data.stats.processed_images || 0;
                
                // Last sync time
                if (data.recent_runs.length > 0) {
                    const lastRun = data.recent_runs.find(r => r.status !== 'running');
                    if (lastRun) {
                        const date = new Date(lastRun.completed_at || lastRun.started_at);
                        document.getElementById('last-sync').textContent = date.toLocaleString();
                    }
                }
                
                // Update runs table
                updateRunsTable(data.recent_runs);
                
            } catch (err) {
                console.error('Failed to fetch status:', err);
            }
        }

        function updateRunsTable(runs) {
            const tbody = document.getElementById('runs-table');
            if (runs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-gray-500">No sync runs yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = runs.map(run => {
                const statusColors = {
                    'running': 'bg-yellow-100 text-yellow-800',
                    'completed': 'bg-green-100 text-green-800',
                    'completed_with_errors': 'bg-orange-100 text-orange-800',
                    'failed': 'bg-red-100 text-red-800',
                };
                const statusClass = statusColors[run.status] || 'bg-gray-100';
                const started = new Date(run.started_at).toLocaleString();
                
                return `
                    <tr class="border-t">
                        <td class="p-3">${started}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${run.status}</span></td>
                        <td class="p-3 text-right">${run.records_processed || 0}</td>
                        <td class="p-3 text-right">${run.images_synced || 0}</td>
                        <td class="p-3 text-right">${run.images_skipped || 0}</td>
                        <td class="p-3 text-right">${run.errors || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        async function triggerSync(fullSync) {
            const btn = fullSync ? document.getElementById('btn-full-sync') : document.getElementById('btn-sync');
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            try {
                const res = await fetch(`${API_BASE}/sync?full_sync=${fullSync}`, { method: 'POST' });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'Failed to start sync');
                    return;
                }
                
                // Start polling for status
                setTimeout(fetchStatus, 1000);
                
            } catch (err) {
                alert('Failed to start sync: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = fullSync ? 'Run Full Sync' : 'Run Incremental Sync';
            }
        }

        async function loadImages(offset = 0) {
            currentOffset = Math.max(0, offset);
            const tags = document.getElementById('filter-tags').value;
            const category = document.getElementById('filter-category').value;
            
            const params = new URLSearchParams({
                limit: 50,
                offset: currentOffset,
            });
            if (tags) params.append('tags', tags);
            if (category) params.append('category', category);
            
            try {
                const res = await fetch(`${API_BASE}/images?${params}`);
                const data = await res.json();
                
                const grid = document.getElementById('images-grid');
                
                if (data.images.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No images found</div>';
                } else {
                    grid.innerHTML = data.images.map(img => `
                        <div class="aspect-square bg-gray-100 rounded overflow-hidden cursor-pointer hover:opacity-80 transition"
                            onclick="showImage('${img.url}', ${JSON.stringify(img).replace(/"/g, '&quot;')})">
                            <img src="${img.url}" alt="${img.original_filename}" 
                                class="w-full h-full object-cover" loading="lazy">
                        </div>
                    `).join('');
                }
                
                // Update pagination
                document.getElementById('btn-prev').disabled = currentOffset === 0;
                document.getElementById('btn-next').disabled = data.images.length < 50;
                document.getElementById('pagination-info').textContent = 
                    `${currentOffset + 1} - ${currentOffset + data.images.length}`;
                
            } catch (err) {
                console.error('Failed to load images:', err);
            }
        }

        function showImage(url, info) {
            document.getElementById('modal-image').src = url;
            document.getElementById('modal-info').innerHTML = `
                <strong>${info.original_filename}</strong><br>
                <span class="text-gray-500">
                    ${(info.file_size_bytes / 1024).toFixed(1)} KB
                    ${info.was_processed ? '(optimized)' : ''}
                    | ${info.category || 'Uncategorized'}
                    ${info.tags?.length ? '| Tags: ' + info.tags.join(', ') : ''}
                </span>
            `;
            document.getElementById('image-modal').classList.remove('hidden');
            document.getElementById('image-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('image-modal').classList.remove('flex');
        }

        // Initial load
        fetchStatus();
        loadImages();
        
        // Poll status every 10s
        setInterval(fetchStatus, 10000);
    </script>
</body>
</html>
